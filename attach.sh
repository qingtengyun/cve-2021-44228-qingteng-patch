#!/bin/bash

FILE_ROOT=`cd \`dirname $0\` && pwd`

cd $FILE_ROOT
pwd

pids="$@"

if [[ "$pids"x == ""x ]]; then
	IFS=$'\n'
	jprocesses=(`jps -l | grep -v sun.tools.jps.Jps`)
	[[ ${#jprocesses[@]} == 0 ]] && echo "jvm processes not found, please input pid manual" && exit 1
	input=""
	allpids=""
	for index in ${!jprocesses[@]}; do
	    if [ "$index" == "0" ] ; then 
	        echo "* $index  "$"${jprocesses[index]}"
	    else
	        echo "  $index  "$"${jprocesses[index]}"
	    fi
	    this_pid=`echo ${jprocesses[index]} | cut -d ' ' -f1`
		allpids="$allpids $this_pid"
	done
	unset IFS

	read input
	if [[ "$input" == "all" ]]; then
		echo "patch all these java process"
		pids="$allpids"
	else
		if [[ "$input"x == ""x ]]; then
			input="0"
		fi

		for index in ${input[@]}; do
			selected_process=${jprocesses[index]}
			this_pid=`echo $selected_process | cut -d ' ' -f1`
			pids="$pids $this_pid"
		done
	fi	
fi

if [[ "$pids"x == ""x ]]; then
	echo "pid not provide" && exit 1
fi

for pid in ${pids[@]}; do 
	echo "will patch pid: $pid"
	echo "$FILE_ROOT/jattach $pid load instrument false $FILE_ROOT/qt-log4j-agent.jar=$FILE_ROOT/qt-log4j-patch.jar"
	$FILE_ROOT/jattach $pid load instrument false "$FILE_ROOT/qt-log4j-agent.jar=$FILE_ROOT/qt-log4j-patch.jar" 
done
