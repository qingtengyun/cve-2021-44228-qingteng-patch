#!/bin/bash

FILE_ROOT=`cd \`dirname $0\` && pwd`
OUTPUT_DIR="build/cve-2021-44228-qingteng-patch"

cd $FILE_ROOT && ./gradlew clean && ./gradlew build

rm -rf $OUTPUT_DIR && mkdir -p $OUTPUT_DIR

cp -f $FILE_ROOT/agent/build/libs/qt-log4j-agent.jar $OUTPUT_DIR/qt-log4j-agent.jar
cp -f $FILE_ROOT/patch/build/libs/qt-log4j-patch.jar $OUTPUT_DIR/qt-log4j-patch.jar
cp attach.bat $OUTPUT_DIR
cp attach.sh $OUTPUT_DIR
cp README.md $OUTPUT_DIR

cd $OUTPUT_DIR
wget https://github.com/apangin/jattach/releases/download/v2.0/jattach && chmod +x jattach
wget https://github.com/apangin/jattach/releases/download/v2.0/jattach.exe

cd ../ && tar czvf cve-2021-44228-qingteng-patch.tar.gz cve-2021-44228-qingteng-patch
